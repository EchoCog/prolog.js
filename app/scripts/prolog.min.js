function Token(a,b,c){c=c||{},this.name=a,this.value=b||null,0===b&&(this.value=0),this.prec=0,this.line=c.line||0,this.col=c.col||0,this.is_primitive=c.is_primitive||!1,this.is_operator=c.is_operator||!1}function Result(a,b){this.terms=a,this.last_token=b}function Op(a,b,c,d,e){this.name=a,this.symbol=b,this.prec=c,this.type=d,this.attrs=e||{},this.line=0,this.col=0}function OpNode(a,b){if(this.symbol=a,this.prec=b||null,null==this.prec){var c=Op.has_ambiguous_precedence(a);try{c===!1&&(this.prec=Op.map_by_symbol[a].prec)}catch(d){throw new Error("Can't find `"+a+"` in Op.map_by_symbol")}}}function Eos(){}function Nothing(){}function Functor(a,b){this.name=a,this.original_token=null,this.prec=0,this.attrs={primitive:!1,"boolean":!1,retvalue:!1},this.line=0,this.col=0,this.arity=null,arguments.length>1?(this.args=Array.prototype.splice.call(arguments,1),this.arity=this.args.length):this.args=[]}function Var(a){this.is_anon="_"==a[0],this.prec=0,this.name=a,this.col=null,this.line=null,this.value=null,this.id=Var.counter++,"_"==this.name[0]&&(this.name=this.name+"$"+this.id)}function Value(a){this.name=a}function Instruction(a,b){this.opcode=a,this.ctx=b||null}function ParseSummary(a,b){this.maybe_error=a,this.maybe_token_list=b}function InComment(){}function ErrorExpectingFunctor(a,b){this.classname="ErrorExpectingFunctor",this.message=a,this.token=b}function ErrorExpectingVariable(a,b){this.classname="ErrorExpectingVariable",this.message=a,this.token=b}function ErrorFunctorNotFound(a,b){this.classname="ErrorFunctorNotFound",this.message=a,this.token=b}function ErrorFunctorClauseNotFound(a,b){this.classname="ErrorFunctorClauseNotFound",this.message=a,this.token=b}function ErrorFunctorCodeNotFound(a,b){this.classname="ErrorFunctorCodeNotFound",this.message=a,this.token=b}function ErrorExpectingGoal(a,b){this.classname="ErrorExpectingGoal",this.message=a,this.token=b}function ErrorInvalidHead(a,b){this.classname="ErrorInvalidHead",this.message=a,this.token=b}function ErrorRuleInQuestion(a,b){this.classname="ErrorRuleInQuestion",this.message=a,this.token=b}function ErrorNoMoreInstruction(a,b){this.classname="ErrorNoMoreInstruction",this.message=a,this.token=b}function ErrorInvalidInstruction(a,b){this.classname="ErrorInvalidInstruction",this.message=a,this.token=b}function ErrorInternal(a,b){this.classname="ErrorInternal",this.message=a,this.token=b}function ErrorInvalidValue(a,b){this.classname="ErrorInvalidValue",this.message=a,this.token=b}function ErrorAlreadyBound(a,b){this.classname="ErrorAlreadyBound",this.message=a,this.token=b}function ErrorNotBound(a,b){this.classname="ErrorNotBound",this.message=a,this.token=b}function ErrorExpectingListStart(a,b){this.classname="ErrorExpectingListStart",this.message=a,this.token=b}function ErrorExpectingListEnd(a,b){this.classname="ErrorExpectingListEnd",this.message=a,this.token=b}function ErrorInvalidToken(a,b){this.classname="ErrorInvalidToken",this.message=a,this.token=b}function ErrorUnexpectedParensClose(a,b){this.classname="ErrorUnexpectedParensClose",this.message=a,this.token=b}function ErrorUnexpectedPeriod(a,b){this.classname="ErrorUnexpectedPeriod",this.message=a,this.token=b}function ErrorUnexpectedEnd(a,b){this.classname="ErrorUnexpectedEnd",this.message=a,this.token=b}function ErrorUnexpectedListEnd(a,b){this.classname="ErrorUnexpectedListEnd",this.message=a,this.token=b}function Compiler(){}function Database(a){this.db={},this.al=a}function DbAccess(){}function Interpreter(a,b){this.db=a,this.stack=b||[],this.tracer=null,this.reached_end_question=!1}function Lexer(a){Array.isArray(a)?this.text=a.join("\n"):this.text=a,this.at_the_end=!1,this.current_match=null,this.current_line=0,this.offset=0,this.comment_start_line=0,this.in_comment=!1,this.comment_chars="",this._tokenRegexp=/[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?|>=|=<|"""|\[|\]|\||\s.is\s.|\d+(\.\d+)?|[A-Za-z_0-9]+|:\-|=|\+\-|\*|\/|\-\+|[()\.,]|[\n\r]|./gm}function ParserL1(a,b){var c={convert_fact:!0};this.list=a,this.reached_end=!1,this.options=b||c}function ParserL2(a,b){this.options=b||{},this.tokens=a,this.index=0,this.ptokens=[]}function ParserL3(a,b,c){this.op_list=b,this.expressions=a}function Utils(){}function Visitor(a){this.exp=a,this.cb=null}function Visitor2(a){this.exp=a,this.cb=null}function Visitor3(a){this.exp=a,this.cb=null}var Prolog={};Prolog.compile=function(a){for(var b=Prolog.parse(a),c=Prolog._combine(b),d=new Compiler,e=[],f=0;f<c.length;f++){var g=d.process_rule_or_fact(c[f]);e.push(g)}return e},Prolog.parse=function(a){var b=new Lexer(a),c=b.process(),d=new ParserL1(c),e=d.process(),f=new ParserL2(e),g=f.process(),h=g.terms,i=new ParserL3(h,Op.ordered_list_by_precedence),j=i.process();return j},Prolog.parse_per_sentence=function(a){for(var b,c,d,e,f,g,h=[],i=new Lexer(a),j=i.process_per_sentence(),k=0;k<j.length;k++){var l=j[k];try{b=new ParserL1(l),e=b.process(),c=new ParserL2(e),f=c.process().terms,d=new ParserL3(f,Op.ordered_list_by_precedence),g=d.process(),h.push(new ParseSummary(null,g[0]))}catch(m){h.push(new ParseSummary(m))}}return h},Prolog._combine=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];b=b.concat(d)}return b},Prolog.compile_query=function(a){},"undefined"!=typeof module&&(module.exports.Prolog=Prolog),Token.inspect_quoted=!1,Token.inspect_compact=!1,Token.prototype.inspect=function(){if(Token.inspect_compact)return"nil"==this.name?"nil":""+this.value;var a="";return a="Token("+this.name+","+this.value+")",Token.inspect_quoted&&(a="'"+a+"'"),a},Token.equal=function(a,b){return a.name==b.name&&a.value==b.value},Token.check_for_match=function(a,b,c){if(c=c||!1,a instanceof Array&&a[0]instanceof Array){for(var d=0;d<a.length;d++)if(!Token.check_for_match(a[d],b[d]))return!1;return!0}if(a.length!=b.length)return!1;for(var d in a){var e=a[d],f=b[d]||new Token("null");if(!Token.equal(e,f))return!1;if(c&&e.col!=f.col)return!1}return!0},Op.prototype.inspect=function(){return"Op("+this.name+")"},Op.parts=function(a){var b=a.split("");return"f"==b[0]?[null,b[0],b[1]]:[b[0],b[1],b[2]||null]},Op.AMBIGUOUS_PRECEDENCE=!0,Op._list=[new Op("rule",":-",1200,"xfx"),new Op("disj",";",1100,"xfy"),new Op("conj",",",1e3,"xfy"),new Op("unif","=",700,"xfx",{builtin:!0,"boolean":!0}),new Op("em","=<",700,"xfx",{primitive:!0,"boolean":!0}),new Op("ge",">=",700,"xfx",{primitive:!0,"boolean":!0}),new Op("lt","<",700,"xfx",{primitive:!0,"boolean":!0}),new Op("gt",">",700,"xfx",{primitive:!0,"boolean":!0}),new Op("is","is",700,"xfx",{primitive:!0,retvalue:!1}),new Op("minus","-",500,"yfx",{primitive:!0,retvalue:!0}),new Op("plus","+",500,"yfx",{primitive:!0,retvalue:!0}),new Op("mult","*",400,"yfx",{primitive:!0,retvalue:!0}),new Op("div","/",400,"yfx",{primitive:!0,retvalue:!0}),new Op("uminus","-",200,"fy"),new Op("uplus","+",200,"fy")],Op._amap={"-":{ambiguous_precence:!0},"+":{ambiguous_precence:!0}},Op.has_ambiguous_precedence=function(a){return Op._amap[a]||!1},function(){Op.map_by_symbol={},Op.map_by_name={},Op.ordered_list_by_precedence=[];for(var a in Op._list){var b=Op._list[a];Op.ordered_list_by_precedence.push(b),Op.map_by_name[b.name]=b,Op.map_by_symbol[b.symbol]=b}Op.ordered_list_by_precedence.sort(function(a,b){return a.prec-b.prec})}(),Op.classify_triplet=function(a,b,c){if(!(b instanceof OpNode))throw Error("Expecting an OpNode from node_center: "+JSON.stringify(b));if(null==b.prec)throw Error("Expecting a valid OpNode for node_center: "+JSON.stringify(b));return Op.__classify(a,b,c)},Op.__classify=function(a,b,c){var d=b.prec,e="";try{a&&(a.prec==d?e+="y":a.prec<d&&(e+="x"))}catch(f){}e+="f";try{c&&(c.prec==d?e+="y":c.prec<d&&(e+="x"))}catch(f){}return e},Op.is_unary=function(a){return"f"==(""+a)[0]},Op.is_compatible_subtype=function(a,b){return null==b&&null!=a?!1:null==a&&null!=b?!1:"y"==a&&"x"==b?!1:!0},Op.are_compatible_types=function(a,b){var c=Op.parts(a),d=Op.parts(b);return Op.is_compatible_subtype(c[0],d[0])&&Op.is_compatible_subtype(c[1],d[1])&&Op.is_compatible_subtype(c[2],d[2])},OpNode.prototype.inspect=function(){return"OpNode(`"+this.symbol+"`,"+this.prec+")"},OpNode.create_from_name=function(a){var b=Op.map_by_name[a];if(!b)throw new Error("OpNode.create_from_name: expecting a valid 'name', got: "+a);var c=new OpNode(b.symbol,b.prec);return c.line=b.line,c.col=b.col,c},Eos.prototype.inspect=function(){return"Eos"},Functor.prototype.get_arity=function(){return this.arity||this.args.length},Functor.prototype.get_name=function(){return this.name},Functor.inspect_compact_version=!1,Functor.inspect_short_version=!1,Functor.inspect_quoted=!1,Functor.prototype.inspect=function(){var a="",b=this.arity||this.args.length;if(Functor.inspect_compact_version){var c=this.format_args(this.args);a=this.name+"("+c+")"}else if(Functor.inspect_short_version)a="Functor("+this.name+"/"+b+")";else{var c=this.format_args(this.args);a=b>0?"Functor("+this.name+"/"+b+","+c+")":"Functor("+this.name+"/"+b+")"}return Functor.inspect_quoted&&(a="'"+a+"'"),a},Functor.prototype.format_args=function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];c>0&&(b+=","),Array.isArray(d)?(b+="[",b+=this.format_args(d),b+="]"):b=this.format_arg(b,d)}return b},Functor.prototype.format_arg=function(a,b){return a+=b&&b.inspect?b.inspect():JSON.stringify(b)},Functor.prototype.get_args=function(){return this.args},Functor.prototype.push_arg=function(a){this.args.push(a)},Functor.prototype.get_arg=function(a){return this.args[a]},Functor.compare=function(a,b){return a.name==b.name&&a.arity==b.arity?!0:!1},Var.counter=0,Var.inspect_extended=!1,Var.inspect_compact=!1,Var.prototype.inspect=function(a){var b=this.is_anon?"_":this.name;if(a=a||0,5==a)return"?CYCLE?";if(this.value){var c=this.value.inspect?this.value.inspect(a+1):this.value;return Var.inspect_compact?c:Var.inspect_extended?"Var("+b+", "+c+"){"+this.id+"}":"Var("+b+", "+c+")"}return Var.inspect_compact?"_":Var.inspect_extended?"Var("+b+"){"+this.id+"}":"Var("+b+")"},Var.prototype.bind=function(a,b){if(this==a)throw new Error("Attempt to create cycle ...");if(null==a)throw new ErrorInvalidValue("Var("+this.name+"), attempted to bind 'null'");if(null!=this.value)throw new ErrorAlreadyBound("Already Bound: Var("+this.name+")");b&&b(this),this.value=a},Var.prototype.is_bound=function(){return null!=this.value},Var.prototype.unbind=function(){return this.value=null},Var.prototype.get_value=function(){if(null==this.value)throw new ErrorNotBound("Not Bound: Var("+this.name+")");return this.value},Var.prototype.deref=function(a){return a&&a==this?null:this.value instanceof Var?this.value.is_bound()?this.value.deref(a):a&&a==this.value?null:this.value:this},Var.prototype.safe_bind=function(a,b){var c,d,c=this.deref(a);if(null==c)return void console.log("!!!!!!!!!! CYCLE AVERTED! ",this);if(a instanceof Var){if(d=a.deref(this),null==d)return void console.log("!!!!!!!!!!! CYCLE AVERTED!",a)}else d=a;return c==d?void console.log("!!!!!!!!!!! CYCLE AVERTED!",a):void c.bind(d,b)},Value.prototype.inspect=function(){return"Value("+this.name+")"},Instruction.inspect_compact=!1,Instruction.inspect_quoted=!1,Instruction.prototype.is=function(a){return this.opcode==a},Instruction.prototype.get=function(a,b){return b?b+this.ctx[a]:this.ctx[a]},Instruction.prototype.get_parameter_name=function(){return this.ctx?this.ctx.p?this.ctx.p:this.ctx.x?"$x"+this.ctx.x:null:null},Instruction.prototype.inspect=function(){const a=["p","x","y"];var b="";if(this.ctx&&this.ctx.l&&(b=this.ctx.l+"  "),b+=this.opcode+Array(13-this.opcode.length).join(" "),null==this.ctx)return b;Instruction.inspect_compact||(b+=" ( "),this.ctx.f&&(b+=this.ctx.f+"/"+this.ctx.a);for(var c=0,d=!1;c<a.length;c++)void 0!=this.ctx[a[c]]&&((d||this.ctx.f&&!d)&&(b+=", "),b+=a[c]+"("+JSON.stringify(this.ctx[a[c]])+")",d=!0);return Instruction.inspect_compact||(b+=" )"),Instruction.inspect_quoted&&(b="'"+b+"'"),b},ParseSummary.prototype.inspect=function(){if(this.maybe_error)return"Error: "+this.maybe_error.classname;if(this.maybe_token_list instanceof Array){for(var a="[",b=0;b<this.maybe_token_list.length;b++){var c=this.maybe_token_list[b];b>0&&(a+=","),a+=c.inspect?c.inspect():JSON.stringify(c)}return a+"]"}return this.maybe_token_list.inspect?"ParseSummary: "+this.maybe_token_list.inspect():JSON.stringify(this.maybe_token_list)},ErrorExpectingFunctor.prototype=Error.prototype,ErrorExpectingVariable.prototype=Error.prototype,ErrorFunctorNotFound.prototype=Error.prototype,ErrorFunctorClauseNotFound.prototype=Error.prototype,ErrorFunctorCodeNotFound.prototype=Error.prototype,ErrorExpectingGoal.prototype=Error.prototype,ErrorInvalidHead.prototype=Error.prototype,ErrorRuleInQuestion.prototype=Error.prototype,ErrorNoMoreInstruction.prototype=Error.prototype,ErrorInvalidInstruction.prototype=Error.prototype,ErrorInternal.prototype=Error.prototype,ErrorInvalidValue.prototype=Error.prototype,ErrorAlreadyBound.prototype=Error.prototype,ErrorNotBound.prototype=Error.prototype,ErrorExpectingListStart.prototype=Error.prototype,ErrorExpectingListEnd.prototype=Error.prototype,ErrorInvalidToken.prototype=Error.prototype,ErrorUnexpectedParensClose.prototype=Error.prototype,ErrorUnexpectedPeriod.prototype=Error.prototype,ErrorUnexpectedEnd.prototype=Error.prototype,ErrorUnexpectedListEnd.prototype=Error.prototype,"undefined"!=typeof module&&(module.exports.Nothing=Nothing,module.exports.Eos=Eos,module.exports.InComment=InComment,module.exports.Functor=Functor,module.exports.Op=Op,module.exports.Var=Var,module.exports.Value=Value,module.exports.OpNode=OpNode,module.exports.Result=Result,module.exports.Instruction=Instruction,module.exports.ParseSummary=ParseSummary,module.exports.ErrorExpectingFunctor=ErrorExpectingFunctor,module.exports.ErrorExpectingVariable=ErrorExpectingVariable,module.exports.ErrorInvalidHead=ErrorInvalidHead,module.exports.ErrorInvalidToken=ErrorInvalidToken,module.exports.ErrorRuleInQuestion=ErrorRuleInQuestion,module.exports.ErrorExpectingGoal=ErrorExpectingGoal,module.exports.ErrorNoMoreInstruction=ErrorNoMoreInstruction,module.exports.ErrorInvalidInstruction=ErrorInvalidInstruction,module.exports.ErrorFunctorNotFound=ErrorFunctorNotFound,module.exports.ErrorFunctorClauseNotFound=ErrorFunctorClauseNotFound,module.exports.ErrorFunctorCodeNotFound=ErrorFunctorCodeNotFound,module.exports.ErrorInternal=ErrorInternal,module.exports.ErrorAlreadyBound=ErrorAlreadyBound,module.exports.ErrorNotBound=ErrorNotBound,module.exports.ErrorExpectingListStart=ErrorExpectingListStart,module.exports.ErrorExpectingListEnd=ErrorExpectingListEnd,module.exports.ErrorUnexpectedListEnd=ErrorUnexpectedListEnd,module.exports.ErrorUnexpectedParensClose=ErrorUnexpectedParensClose,module.exports.ErrorUnexpectedPeriod=ErrorUnexpectedPeriod,module.exports.ErrorUnexpectedEnd=ErrorUnexpectedEnd),Compiler.prototype.process_rule_or_fact=function(a){if(!(a instanceof Functor))throw new ErrorExpectingFunctor("Expecting Functor, got: "+JSON.stringify(a),a);if("rule"==a.name)return this.process_rule(a);var b=!1,c={head:this.process_head(a,b),f:a.name,a:a.args.length};return c},Compiler.prototype.process_rule=function(a){var b=a.args[0],c=a.args[1],d={},e=!0,f=!1;d.head=this.process_head(b,e);var g=d.head.vars,h=this.process_body(c,f,g);for(var i in h)d[i]=h[i];return d.f=b.name,d.a=b.args.length,delete d.head.vars,d},Compiler.prototype.process_head=function(a,b){if(!(a instanceof Functor))throw new ErrorExpectingFunctor("Expecting Functor",a);if("conj"==a.name||"disj"==a.name)throw new ErrorInvalidHead("Unexpected conjunction or disjunction within Functor head",a);var c=new Visitor(a),d=[],e={};return c.process(function(a){if(a.is_struct)return a.as_param?void d.push(new Instruction("get_var",{x:a.v})):void d.push(new Instruction("get_struct",{f:a.n.name,a:a.n.args.length,x:a.v}));if(a.n instanceof Var){var b=void 0==e[a.n.name],c=a.root_param;return b&&c&&d.push(new Instruction("get_var",{p:a.n.name})),b&&!c&&("_"==a.n.name[0]?d.push(new Instruction("unif_void")):d.push(new Instruction("unif_var",{p:a.n.name}))),!b&&c&&d.push(new Instruction("get_value",{p:a.n.name})),b||c||d.push(new Instruction("unif_value",{p:a.n.name})),void(e[a.n.name]=!0)}if(a.n instanceof Token){if("nil"==a.n.name)return void d.push(new Instruction("unif_nil"));if("term"==a.n.name)return void(a.root_param?d.push(new Instruction("get_term",{p:a.n.value})):d.push(new Instruction("unify_term",{p:a.n.value})));if("number"==a.n.name)return void(a.root_param?d.push(new Instruction("get_number",{p:a.n.value})):d.push(new Instruction("unify_number",{p:a.n.value})))}}),b?d.push(new Instruction("jump",{p:"g0"})):d.push(new Instruction("proceed")),d.vars=e,d},Compiler.prototype.process_query=function(a){if(!(a instanceof Functor))throw new ErrorExpectingFunctor("Expecting Functor",a);if("rule"==a.name)throw new ErrorRuleInQuestion("Unexpected rule definition in query",a);var b=!0;return this.process_body(a,b)},Compiler.prototype.process_body=function(a,b,c){var d=c,e={},f={},g={},h=new Visitor3(a),i=this,j=function(a,b){var c=g[a];return b||c?c?j(c,c):b:a},k=function(a,b,c){var d="g"+b.vc,e="g"+c.vc,h=f[d],i=h[h.length-1];"proceed"==i.opcode&&h.pop(),"end"==i.opcode&&h.pop();var j=b.n&&b.n.attrs.primitive;j||f[d].push(new Instruction("maybe_fail")),f[d]=f[d].concat(f[e]),g[e]=d,delete f[e];var k="g"+a.vc;f[k]=f[d],g[d]=k,delete f[d]},l=function(a,b,c){var d="g"+a.vc,h="g"+b.vc,i="g"+c.vc;if(b.n)f[h].unshift(new Instruction("try_else",{p:i}));else{var k=e[h],l=k.r,m=j(l);f[m].unshift(new Instruction("try_else",{p:i}))}f[d]=f[h],g[h]=d,a.root&&f[i].unshift(new Instruction("try_finally")),delete f[h]};return h.process(function(a,c,g){var h=a.type,j=a.goal_id,m=a.root,n=h+j,o=c;if(m&&(n="g0"),"root"==h)return n="g0",void(f[n]=i.process_goal(o.n,b,d));var p=i.process_goal(c.n,b,d),q=i.process_goal(g.n,b,d),r="g"+a.vc,s="g"+c.vc,t="g"+g.vc;e[r]={l:s,r:t},p&&(f[s]=p),q&&(f[t]=q),"conj"==h&&k(a,c,g),"disj"==h&&l(a,c,g)}),f},Compiler.prototype.process_goal=function(a,b,c){if(c=c||{},void 0==a)return void 0;if("cut"==a.name)return[new Instruction("cut"),new Instruction("proceed")];if(a.attrs.primitive)return this.process_primitive(a,b,c);var d=new Visitor2(a),e=[];return e.push(new Instruction("allocate")),d.process(function(a){var d={f:a.n.name,a:a.n.args.length,x:a.vc};a.root&&(d.x=0),e.push(new Instruction("put_struct",d));for(var f=0;f<a.args.length;f++){var g=a.args[f];g instanceof Var&&("_"==g.name[0]?e.push(new Instruction("put_void")):c[g.name]||b?e.push(new Instruction("put_var",{p:g.name})):(e.push(new Instruction("unif_var",{p:g.name})),c[g.name]=!0)),g instanceof Value&&e.push(new Instruction("put_value",{x:g.name})),g instanceof Token&&("number"==g.name&&e.push(new Instruction("put_number",{p:g.value})),"term"==g.name&&e.push(new Instruction("put_term",{p:g.value})),"nil"==g.name&&e.push(new Instruction("put_nil")))}a.root&&(a.n.attrs.builtin?(e.push(new Instruction("setup")),e.push(new Instruction("bcall")),e.push(new Instruction("maybe_retry")),e.push(new Instruction("deallocate"))):(e.push(new Instruction("setup")),e.push(new Instruction("call")),e.push(new Instruction("maybe_retry")),e.push(new Instruction("deallocate"))),b?e.push(new Instruction("end")):e.push(new Instruction("proceed")))}),e},Compiler.prototype.process_primitive=function(a,b,c){var d=new Visitor2(a),e=[];return d.process(function(a){var b=a.n.name;e.push(new Instruction("prepare"));for(var d=0;d<a.args.length;d++){var f=a.args[d];if(f instanceof Var&&(e.push(new Instruction("push_var",{p:f.name})),c[f.name]=!0),f instanceof Value&&e.push(new Instruction("push_value",{y:f.name})),f instanceof Token){if("number"==f.name&&e.push(new Instruction("push_number",{p:f.value})),"term"==f.name)throw new ErrorInvalidToken("term: "+JSON.stringify(f.value),f);if("nil"==f.name)throw new ErrorInvalidToken("nil",f)}}var g="op_"+b;a.n.attrs["boolean"]||!a.n.attrs.retvalue?e.push(new Instruction(g)):e.push(new Instruction(g,{y:a.vc}))}),e.push(new Instruction("proceed")),e},"undefined"!=typeof module&&(module.exports.Compiler=Compiler),Database.prototype.insert=function(a){a instanceof Array||(a=[a]);for(var b in a)this._insert(a[b])},Database.prototype._insert=function(a){var b=this.al.compute_signature(a),c=this.db[b]||[];return c.push(a),this.db[b]=c,b},Database.prototype.batch_insert_code=function(a){a instanceof Array||(a=[a]);for(var b in a){var c=a[b],d=c.f,e=c.a;this.insert_code(d,e,c)}},Database.prototype.insert_code=function(a,b,c){var d=this.al.compute_signature([a,b]),e=this.db[d]||[];e.push(c),this.db[d]=e},Database.prototype.get_code=function(a,b){var c=this.al.compute_signature([a,b]),d=this.db[c]||[];return d},Database.prototype.get=function(a){var b=this.al.compute_signature(a);return this.db[b]||null},Database.prototype.define=function(a){var b=this.al.compute_signature(a);this.db[b]=a},Database.prototype.lookup_functor=function(a){return this.db[a]||null},"undefined"!=typeof module&&(module.exports.Database=Database),DbAccess.compute_signature=function(a){if(a instanceof Array){var b=a[0],c=a[1];return b+"/"+c}var d=null;try{var e=DbAccess.extract_head_of_rule(a);d=DbAccess.get_functor_signature(e)}catch(f){d=DbAccess.get_functor_signature(a)}return d},DbAccess.is_fact=function(a){return a instanceof Functor?"rule"!=a.name:!1},DbAccess.is_rule=function(a){return a instanceof Functor?"rule"==a.name:!1},DbAccess.extract_head_of_rule=function(a){if(!(a instanceof Functor)||"rule"!=a.name)throw new Error("Expecting a `rule`, got: "+a.name);return a.args[0]},DbAccess.get_functor_signature=function(a){if(!(a instanceof Functor))throw new Error("Expecting Functor, got: "+JSON.stringify(a));return""+a.name+"/"+a.args.length},"undefined"!=typeof module&&(module.exports.DbAccess=DbAccess),Interpreter.prototype.get_stack=function(){return this.stack},Interpreter.prototype.set_tracer=function(a){this.tracer=a},Interpreter.prototype.set_question=function(a){a instanceof Array?this.db.insert_code(".q.",0,a[0]):this.db.insert_code(".q.",0,a),this.ctx={step_counter:0,p:{f:".q.",a:0,ci:0,ct:1,l:"g0",i:0},cc:null,cv:null,cs:null,csx:null,csi:0,csm:"r",cu:!0,tse:{},cse:{},end:!1},this.stack=[];var b={qenv:!0,cp:{},vars:{},trail:[],ci:0,ct:0,te:null,cv:null};this.stack.push(b),this.ctx.cse=b,this.ctx.tse=null,this._execute()},Interpreter.prototype.backtrack=function(){if(this.tracer&&this.tracer("backtracking",this.ctx),this.ctx.cu=!1,this.ctx.end=!1,this.ctx.tse.qenv)return!1;var a=this.ctx.tse.cut;if(void 0==a)return this._restore_continuation(this.ctx.tse.cp),this._execute(),!0;for(;!this.ctx.tse.qenv;){this._unwind_trail(this.ctx.tse.trail);var b=this.ctx.tse.spos;if(a==b)break;this.stack.pop(),this.ctx.tse=this.stack[this.stack.length-1],this.ctx.cse=this.ctx.tse}return this.ctx.tse.qenv?!1:(this._restore_continuation(this.ctx.tse.cp),this._execute(),!0)},Interpreter.prototype.step=function(){if(this.ctx.end)return!0;this.ctx.step_counter++;var a=this.fetch_next_instruction(),b="inst_"+a.opcode,c=this[b];if(!c)throw new ErrorInvalidInstruction(a.opcode,a);return this.tracer?(this.tracer("before_inst",this,a),this[b].apply(this,[a]),this.tracer("after_inst",this,a)):this[b].apply(this,[a]),this.ctx.end},Interpreter.prototype.fetch_next_instruction=function(){var a=this.ctx.cc[this.ctx.p.l][this.ctx.p.i];if(this.ctx.p.i++,a)return a;throw new ErrorNoMoreInstruction("No More Instruction",a)},Interpreter.prototype._get_code=function(a,b,c){var d,e={};try{d=this.db.get_code(a,b),e.ct=d.length}catch(f){var g=a+"/"+b;throw new ErrorFunctorNotFound("Functor not found: "+g,g)}if(c>=e.ct){var g=a+"/"+b;throw new ErrorFunctorClauseNotFound("Functor clause not found: "+g,g)}if(e.cc=d[c],!e.cc){var g=a+"/"+b;return ErrorFunctorCodeNotFound("Functor clause code not found: "+g,g)}return e},Interpreter.prototype._goto=function(a){this.ctx.p.l=a,this.ctx.p.i=0},Interpreter.prototype._execute=function(a){var b={};return a?(b=this._get_code(a.f,a.a,a.ci),this.ctx.p.f=a.f,this.ctx.p.a=a.a,this.ctx.p.ci=a.ci,this.ctx.p.i=0,this.ctx.cc=b.cc,this.ctx.p.ct=b.ct):(b=this._get_code(this.ctx.p.f,this.ctx.p.a,this.ctx.p.ci),this.ctx.cc=b.cc),a&&(this.ctx.p.l=a.l||"head"),this.tracer&&this.tracer("execute",this.ctx),b},Interpreter.prototype._restore_continuation=function(a){this.tracer&&this.tracer("restore",a),this.ctx.cse=a.ce,this.ctx.te=a.te,this.ctx.p.f=a.p.f,this.ctx.p.a=a.p.a,this.ctx.p.ci=a.p.ci,this.ctx.p.ct=a.p.ct,this.ctx.p.l=a.p.l,this.ctx.p.i=a.p.i},Interpreter.prototype._save_continuation=function(a,b){a.p={},a.ce=this.ctx.cse,a.te=this.ctx.te,a.p.f=this.ctx.p.f,a.p.a=this.ctx.p.a,a.p.ci=this.ctx.p.ci,a.p.ct=this.ctx.p.ct,a.p.l=this.ctx.p.l,a.p.i=this.ctx.p.i+(b||0),this.tracer&&this.tracer("save",a)},Interpreter.prototype._add_to_trail=function(a,b){var c=b.name;a[c]=b},Interpreter.prototype.maybe_add_to_trail=function(a,b){var c=b.deref();if(!c.is_bound()){var d=c.name;a[d]=c}},Interpreter.prototype._unwind_trail=function(a){for(var b in a){var c=a[b];c.is_bound()&&c.unbind()}a={}},Interpreter.prototype.get_query_vars=function(){return this.ctx.cse.vars},Interpreter.prototype.inst_end=function(){this.ctx.end=!0},Interpreter.prototype.inst_setup=function(){this._save_continuation(this.ctx.tse.cp,1),this.ctx.tse.p.ci=0,this.ctx.tse.p.ct=0},Interpreter.prototype.inst_bcall=function(a){this.ctx.cse=this.ctx.tse,this.ctx.cu=!0;var b=this.ctx.tse.vars.$x0;this.ctx.tse.vars={},this.ctx.tse.vars.$x0=b;var c=b.name,d=this["builtin_"+c];if(!d)throw new ErrorFunctorNotFound(c,c);d.apply(this,[b])},Interpreter.prototype.builtin_unif=function(a){var b=a.args[0],c=a.args[1],d=this;this.ctx.cu=Utils.unify(b,c,function(a){d.maybe_add_to_trail(d.ctx.cse.trail,a)})},Interpreter.prototype.inst_call=function(a){var b=this.ctx.tse.vars.$x0;this.ctx.tse.vars={},this.ctx.tse.vars.$x0=b,this.ctx.cu=!1,this.ctx.cs=null,this.ctx.csx=null,this.ctx.csm="r",this.ctx.csi=0;var c=b.name,d=b.args.length,e=this._execute({f:c,a:d,ci:this.ctx.tse.p.ci});this.ctx.tse.p.ct=e.ct,this.ctx.cse=this.ctx.tse,this.ctx.cu=!0},Interpreter.prototype.inst_maybe_retry=function(){this.ctx.cu||(this._unwind_trail(this.ctx.tse.trail),this.ctx.tse.p.ci++,this.ctx.tse.p.ci<this.ctx.tse.p.ct&&(this.ctx.p.i-=2))},Interpreter.prototype.inst_allocate=function(){var a={vars:{},cp:{},trail:{},p:{},spos:this.stack.length};this.ctx.tse=a,this.stack.push(a)},Interpreter.prototype.inst_deallocate=function(){this.ctx.cu||(this._unwind_trail(this.ctx.tse.trail),this._deallocate())},Interpreter.prototype._deallocate=function(){this.stack.pop(),this.ctx.tse=this.stack[this.stack.length-1]},Interpreter.prototype.inst_maybe_fail=function(){return this.ctx.cu?void 0:this.ctx.cse.te?(this._goto(this.ctx.cse.te),void(this.ctx.cse.te=null)):void this.backtrack()},Interpreter.prototype.inst_try_else=function(a){var b=a.get("p");this.ctx.cse.te=b},Interpreter.prototype.inst_try_finally=function(){this.ctx.cse.te=null},Interpreter.prototype.inst_jump=function(a){var b=a.get("p");this.ctx.p.l=b,this.ctx.p.i=0},Interpreter.prototype.inst_proceed=function(){return this.ctx.cu?(this._restore_continuation(this.ctx.cse.cp),void this._execute()):this.ctx.cse.te?(this._goto(this.ctx.cse.te),void(this.ctx.cse.te=null)):void this.backtrack()},Interpreter.prototype.inst_cut=function(){var a=this.ctx.cse.spos;this.ctx.tse.cut=a,this.ctx.cu=!0},Interpreter.prototype.inst_prepare=function(a){this.ctx.cse.vars.$y0=new Functor("$op"),this.ctx.cu=!0},Interpreter.prototype.inst_push_var=function(a){var b=a.get("p"),c=this.ctx.cse.vars.$y0,d=this.ctx.cse.vars[b];d||(d=new Var(b),this.ctx.cse.vars[d.name]=d),c.push_arg(d)},Interpreter.prototype._get_value=function(a){if(a instanceof Var){var b=a.deref();if(!b.is_bound())throw new ErrorErrorNotBound("Expecting bound variable for: "+a.name,a);a=b.get_value()}if(Utils.isNumeric(a))return a;if(a instanceof Token&&"number"==a.name)return a.value;throw new ErrorInvalidToken("Invalid Token: Got: "+JSON.stringify(a),a)},Interpreter.prototype.inst_push_value=function(a){var b=a.get("y","$y"),c=this.ctx.cse.vars.$y0,d=this.ctx.cse.vars[b],e=this._get_value(d);c.push_arg(e)},Interpreter.prototype.inst_push_number=function(a){var b=a.get("p"),c=this.ctx.cse.vars.$y0;c.push_arg(b)},Interpreter.prototype.inst_op_unif=function(a){var b=this.ctx.cse.vars.$y0,c=this._get_value(b.args[0]),d=this._get_value(b.args[1]);return this.ctx.cu=Utils.unify(c,d),this._exit()},Interpreter.prototype._exit=function(){return this.ctx.cu?void 0:this.ctx.cse.te?(this._goto(this.ctx.cse.te),void(this.ctx.cse.te=null)):void this.backtrack()},Interpreter.prototype.inst_op_is=function(a){var b=this.ctx.cse.vars.$y0,c=b.args[0],d=b.args[1];if(!(c instanceof Var))throw new ErrorExpectingVariable("Expecting a variable as lvalue of `is`, got: "+JSON.stringify(c),a);c.bind(d),this.ctx.cu=!0},Interpreter.prototype._get_values=function(){var a,b,c=this.ctx.cse.vars.$y0,d=c.args[0],e=c.args[1];return a=d instanceof Var?d.deref().get_value():Utils.isNumeric(d)?d:d.value,b=e instanceof Var?e.deref().get_value():Utils.isNumeric(e)?e:e.value,{r:b,l:a}},Interpreter.prototype.inst_op_plus=function(a){var b=a.get("y","$y"),c=this._get_values();this.ctx.cse.vars[b]=c.l+c.r,this.ctx.cu=!0},Interpreter.prototype.inst_op_minus=function(a){var b=a.get("y","$y"),c=this._get_values();this.ctx.cse.vars[b]=c.l-c.r,this.ctx.cu=!0},Interpreter.prototype.inst_op_mult=function(a){var b=a.get("y","$y"),c=this._get_values();this.ctx.cse.vars[b]=c.l*c.r,this.ctx.cu=!0},Interpreter.prototype.inst_op_div=function(a){var b=a.get("y","$y"),c=this._get_values();this.ctx.cse.vars[b]=c.l/c.r,this.ctx.cu=!0},Interpreter.prototype.inst_op_gt=function(){var a=this._get_values();this.ctx.cu=a.l>a.r,this._exit()},Interpreter.prototype.inst_op_lt=function(){var a=this._get_values();this.ctx.cu=a.l<a.r,this._exit()},Interpreter.prototype.inst_op_ge=function(){var a=this._get_values();this.ctx.cu=a.l>=a.r,this._exit()},Interpreter.prototype.inst_op_em=function(){var a=this._get_values();this.ctx.cu=a.l<=a.r,this._exit()},Interpreter.prototype.inst_put_struct=function(a){var b=new Functor(a.get("f")),c=a.get("a");b.arity=c;var d="$x"+a.get("x");this.ctx.cv=d,this.ctx.tse.vars[d]=b},Interpreter.prototype.inst_put_term=function(a){var b=a.get("p"),c=this.ctx.cv,d=this.ctx.tse.vars[c];d.push_arg(b)},Interpreter.prototype.inst_put_number=function(a){var b=a.get("p"),c=this.ctx.cv,d=this.ctx.tse.vars[c];d.push_arg(new Token("number",b))},Interpreter.prototype.inst_put_void=function(){var a=this.ctx.cv,b=this.ctx.tse.vars[a],c=new Var("_");b.push_arg(c)},Interpreter.prototype.inst_put_nil=function(){var a=this.ctx.cv,b=this.ctx.tse.vars[a];b.push_arg(new Token("nil"))},Interpreter.prototype.inst_put_var=function(a){var b=a.get("p"),c=this.ctx.cv,d=this.ctx.tse.vars[c],e=this.ctx.cse.vars[b];e||(e=new Var(b),this.ctx.cse.vars[e.name]=e),d.push_arg(e)},Interpreter.prototype.inst_put_value=function(a){var b=a.get("x","$x"),c=this.ctx.tse.vars[b],d=this.ctx.cv,e=this.ctx.tse.vars[d];e.push_arg(c)},Interpreter.prototype.inst_unif_value=function(a){var b=a.get("p"),c=this.ctx.cse.vars[b];if("w"==this.ctx.csm)return this.ctx.cs.push_arg(c),void(this.ctx.cu=!0);var d=this.ctx.cs.get_arg(this.ctx.csi++),e=this;this.ctx.cu=Utils.unify(d,c,function(a){e.maybe_add_to_trail(e.ctx.cse.trail,a)}),this.ctx.cu||this.backtrack()},Interpreter.prototype.inst_unif_void=function(){if(this.ctx.csi++,this.ctx.cu=!0,"w"==this.ctx.csm){var a=new Var("_");this._add_to_trail(this.ctx.cse.trail,a),this.ctx.cs.push_arg(a)}},Interpreter.prototype.inst_unif_nil=function(){if("w"==this.ctx.csm)return this.ctx.cs.push_arg(new Token("nil")),void(this.ctx.cu=!0);var a=this.ctx.cs.get_arg(this.ctx.csi++);this.ctx.cu=Utils.unify(a,new Token("nil")),this.ctx.cu||this.backtrack()},Interpreter.prototype.inst_unif_var=function(a){var b=a.get("p");b||(b=a.get("x","$x"));var c=this.ctx.cse.vars[b];if(c||(c=new Var(b),this.ctx.cse.vars[c.name]=c),"w"==this.ctx.csm)return this.ctx.cs.push_arg(c),void(this.ctx.cu=!0);var d=this.ctx.cs.get_arg(this.ctx.csi++),e=this;this.ctx.cu=Utils.unify(c,d,function(a){
e._add_to_trail(e.ctx.cse.trail,a)}),this.ctx.cu||this.backtrack()},Interpreter.prototype.inst_get_var=function(a){var b=a.get("p")||a.get("x","$x"),c=this.ctx.cs.get_arg(this.ctx.csi++);this.ctx.cse.vars[b]=c,this.ctx.cu=!0},Interpreter.prototype.inst_get_value=function(a){var b=a.get("p"),c=this.ctx.cs.get_arg(this.ctx.csi++),d=this.ctx.cse.vars[b],e=this;this.ctx.cu=Utils.unify(d,c,function(a){e.maybe_add_to_trail(e.ctx.cse.trail,a)})},Interpreter.prototype.inst_get_struct=function(a){var b=a.get("x","$x");if(b==this.ctx.csx)throw new ErrorInternal("Attempting to 'get_struct' again on same argument: "+b,a);this.ctx.csm="r",this.ctx.csx=b;var c=a.get("f"),d=a.get("a");this.ctx.cu=!1,this.ctx.cs=null,this.ctx.csi=0;var e,f=this.ctx.cse.vars[b];if(f instanceof Var&&(e=f.deref(),!e.is_bound())){this._add_to_trail(this.ctx.cse.trail,f),this.ctx.csm="w";var g=new Functor(c);return this.ctx.cs=g,e.bind(g),void(this.ctx.cu=!0)}this.ctx.csm="r";var h=f;return e&&(h=e.get_value()),h instanceof Functor?h.get_name()!=c?this.backtrack():h.get_arity()!=+d?this.backtrack():(this.ctx.cs=h,void(this.ctx.cu=!0)):void this.backtrack()},Interpreter.prototype.inst_get_number=function(a){this._get_x(a,"number"),this.ctx.cu||this.backtrack()},Interpreter.prototype.inst_get_term=function(a){this._get_x(a,"term"),this.ctx.cu||this.backtrack()},Interpreter.prototype._get_x=function(a,b){var c=a.get("p");if("w"==this.ctx.csm)return this.ctx.cs.push_arg(new Token(b,c)),void(this.ctx.cu=!0);var d=this.ctx.cs.get_arg(this.ctx.csi++);if(this.ctx.cu=!1,d instanceof Token){if(d.name==b)return void(this.ctx.cu=d.value==c)}else{if(d==c)return void(this.ctx.cu=!0);if(!(!d instanceof Var)){var e=d,f=e.deref();if(f.is_bound())return void(this.ctx.cu=f.get_value()==c);f.bind(c),this._add_to_trail(this.ctx.cse.trail,f),this.ctx.cu=!0}}},"undefined"!=typeof module&&(module.exports.Interpreter=Interpreter),Lexer.prototype._handleNewline=function(){this.offset=this._tokenRegexp.lastIndex,this.current_line=this.current_line+1},Lexer.prototype._computeIndex=function(a){return a-this.offset},Lexer.token_map={":-":function(){return new Token("op:rule",":-",{is_operator:!0})},",":function(){return new Token("op:conj",",",{is_operator:!0})},";":function(){return new Token("op:disj",";",{is_operator:!0})},"=":function(){return new Token("op:unif","=",{is_operator:!0})},"<":function(){return new Token("op:lt","<",{is_operator:!0})},">":function(){return new Token("op:gt",">",{is_operator:!0})},"=<":function(){return new Token("op:em","=<",{is_operator:!0})},">=":function(){return new Token("op:ge",">=",{is_operator:!0})},"-":function(){return new Token("op:minus","-",{is_operator:!0})},"+":function(){return new Token("op:plus","+",{is_operator:!0})},"*":function(){return new Token("op:mult","*",{is_operator:!0})},"/":function(){return new Token("op:div","/",{is_operator:!0})},is:function(){return new Token("op:is","is",{is_operator:!0})},"|":function(){return new Token("list:tail","|")},"\n":function(){return new Token("newline")},".":function(){return new Token("period")},"(":function(){return new Token("parens_open",null)},")":function(){return new Token("parens_close",null)},"[":function(){return new Token("list:open",null)},"]":function(){return new Token("list:close",null)}},Lexer.newline_as_null=!0,Lexer.prototype.process=function(){for(var a,b=[];;)if(a=this.next(),!(a instanceof InComment)){if(a&&"null"==a.name|"eof"==a.name)break;void 0!==a&&b.push(a)}return b},Lexer.InComment=new InComment,Lexer.prototype.process_per_sentence=function(){for(var a,b=[],c=[];;)if(a=this.next(),!(a instanceof InComment)){if(null==a||"eof"==a.name){c.length>0&&b.push(c);break}"newline"!=a.name&&("period"!=a.name?c.push(a):(b.push(c),c=[]))}return b},Lexer.prototype.step=function(a){return this.at_the_end?null:(this.current_match=this._tokenRegexp.exec(this.text),null!=this.current_match?this.current_match[0]:(this.at_the_end=!0,null))},Lexer.prototype.is_quote=function(a){return"'"==a|'"'==a},Lexer.is_number=function(a){return String(parseFloat(a))==String(a)},Lexer.prototype.next=function(){function a(a){return new Token("term",a)}var b=null,c=this.step();if(null==c)return new Token("eof");var d=c,e=this._computeIndex(this.current_match.index);if(this.in_comment&&'"""'!=d)return this.comment_chars+=d,"\n"==d&&this.current_line++,Lexer.InComment;if('"""'==d)return this.in_comment?(this.in_comment=!1,b=new Token("comment",this.comment_chars),b.col=0,b.line=this.comment_start_line,b):(this.in_comment=!0,this.comment_start_line=this.current_line,this.comment_chars="",Lexer.InComment);if("%"==d){b=new Token("comment",null),b.col=e,b.line=this.current_line,this.current_line=this.current_line+1;for(var f="";;){var g=this.step(Lexer.newline_as_null);if(null==g||"\n"==g||"\r"==g)break;f+=g}return b.value=f,b}if(Lexer.is_number(d)){var h=parseFloat(d);return b=new Token("number",h),b.is_primitive=!0,b.col=e,b.line=this.current_line,b}if(this.is_quote(d))for(var i,j="";;){if(i=this.step(),this.is_quote(i)|"\n"==i|null==i)return b=new Token("string",j),b.is_primitive=!0,b.col=e,b.line=this.current_line,b;j+=i}var k=Lexer.token_map[c]||a;return b=k(c),b.col=e,b.line=this.current_line,"newline"==b.name&&this._handleNewline(),b},"undefined"!=typeof module&&(module.exports.Lexer=Lexer,module.exports.Token=Token),ParserL1.prototype.next=function(){if(this.reached_end)return new Eos;var a;do a=this.list.shift();while(null===a);if(void 0===a)return new Eos;if("term"==a.name){var b=(a.value||"").replace(/\s/g,"");if(0==b.length)return null}var c=this.list.shift()||null;if(null==c&&(this.reached_end=!0),c&&"list:close"==c.name&&"list:open"==a.name)return a.name="nil",[a];if(c&&"parens_open"==c.name&&("term"==a.name||"string"==a.name))return a.name="functor",[a];if(this.list.unshift(c),"term"==a.name&&null!=a.value){var d=""+a.value[0];d.toUpperCase()==d&&ParserL1.isLetter(d)&&(a.name="var"),"_"==d&&1==a.value.length&&(a.name="var",a.value="_")}return[a]},ParserL1.isLetter=function(a){var b=a.charCodeAt(0);return b>=65&&90>=b||b>=97&&122>=b},ParserL1.prototype.process=function(){for(var a=[];;){var b=this.next();if(null!=b){if(b instanceof Eos)break;Array.prototype.push.apply(a,b)}}return a},"undefined"!=typeof module&&(module.exports.ParserL1=ParserL1),ParserL2.compute_ops_replacement=function(a,b){var c;if("-"==a.value){if("-"==b.value)return c=new OpNode("+",500),c.line=b.line,c.col=b.col,c;if("+"==b.value)return c=new OpNode("-",500),c.line=b.line,c.col=b.col,c}if("+"==a.value){if("+"==b.value)return c=new OpNode("+",500),c.line=b.line,c.col=b.col,c;if("-"==b.value)return c=new OpNode("-",500),c.line=b.line,c.col=b.col,c}return null},ParserL2.preprocess_list=function(a,b){b=b||0;for(var c=[],d=0;;b++){var e=a[b];if(!e)break;if("list:open"!=e.name){if("list:close"!=e.name)"op:conj"!=e.name&&c.push(e);else if(d--,c.push(e),0==d)break}else d++,c.push(e)}return c},ParserL2.nil=new Token("nil"),ParserL2.prototype.next=function(){var a=this.tokens[this.index]||null;return this.index=this.index+1,a},ParserL2.prototype.regive=function(){this.index--},ParserL2.prototype.get_token=function(){for(var a;(a=this.next(),a)&&(!a||"comment"==a.name||"newline"==a.name););return a},ParserL2.prototype.process_list=function(){var a=this.get_token(),b=a.name||null;if("nil"==b)return a;if("list:open"!=b)throw new ErrorExpectingListStart("Expected the start of a list, got: "+JSON.stringify(a),a);return this._process_list()},ParserL2.prototype._process_list=function(a){function b(a){var b=new Token("nil");return b.line=a?a.line:null,b.col=a?a.col:null,b}for(var c=a||this.get_token();c&&("op:conj"==c.name||","==c.symbol);)c=this.get_token();if(!c||"nil"==c.name)return b(c);if("list:close"==c.name)return b(c);var d,e=new Functor("cons");if("list:open"==c.name){var f=this._process_list();e.push_arg(f)}else"functor"==c.name&&(this.regive(),d=this._process({process_functor:!0}),c=d.terms),e.push_arg(c);var g=this.get_token();if(null==g)throw new ErrorUnexpectedEnd("Unexpected end in list definition");if("list:tail"==g.name){if(g=this.get_token(),null==g)throw new ErrorUnexpectedEnd("Unexpected end in list definition");if("functor"==g.name&&(this.regive(),d=this._process({process_functor:!0}),g=d.terms),e.push_arg(g),g=this.get_token(),null==g)throw new ErrorUnexpectedEnd("Unexpected end in list definition");if("list:close"!=g.name)throw new ErrorExpectingListEnd("Expecting list end, got:"+JSON.stringify(g),g);return e}var h=this._process_list(g);return e.push_arg(h),e},ParserL2.prototype.process=function(){this._preprocess(),this.index=0,this.tokens=this.ptokens;for(var a,b=[];a=this._process(),a.terms.length>0&&b.push(a.terms),!(null==a.last_token||a.last_token instanceof Eos););return new Result(b,this.index)},ParserL2.prototype._process=function(a){a=a||{};for(var b=new Array,c=null;;){if(c=this.get_token(),null==c||c instanceof Eos){if(a.diving_functor)throw new ErrorUnexpectedEnd("Within a Functor definition",c);return new Result(b,c)}if("list:close"==c.name)throw new ErrorUnexpectedListEnd("Close list within corresponding Open list",c);if("list:open"!=c.name){if(!(a.diving_functor&&c instanceof OpNode&&","==c.symbol)){if("parens_close"==c.name){if(a.diving_functor)return new Result(b,c);throw new ErrorUnexpectedParensClose("Parens close without corresponding parens open",c)}if("period"==c.name){if(a.diving_functor)throw new ErrorUnexpectedPeriod("Unexpected period within Functor definition",c);return new Result(b,c)}if("functor"!=c.name)b.push(c);else{var d=this._process({diving_functor:!0}),e=new Functor(c.value);if(e.args=d.terms,e.original_token=c,e.line=c.line,e.col=c.col,a.process_functor)return new Result(e,c);b.push(e)}}}else{this.regive();var f=this.process_list();b.push(f)}}},ParserL2.prototype._preprocess=function(){for(var a,b;(a=this.get_token(),null!=a)&&!(a instanceof Eos);)if("var"!=a.name)if("parens_open"!=a.name)if("term"!=a.name||"!"!=a.value)if("+-"!=a.value&&"-+"!=a.value){if(a.is_operator&&(b=this.tokens[this.index]||null,b&&b.is_operator)){var c=ParserL2.compute_ops_replacement(a,b);if(null!=c){c.line=a.line,c.col=a.col,this.ptokens.push(c),this.index=this.index+1;continue}}if(a.is_operator){var d=new OpNode(a.value);d.line=a.line,d.col=a.col,this.ptokens.push(d)}else this.ptokens.push(a)}else{var d=new OpNode("-",500);d.line=a.line,d.col=a.col,this.ptokens.push(d)}else{var e=new Functor("cut");e.attrs.primitive=!0,e.original_token=a,e.line=a.line,e.col=a.col,this.ptokens.push(e)}else a.name="functor",a.value="expr",a.prec=0,a.is_operator=!1,a.attrs=a.attrs||{},a.attrs.primitive=!0,this.ptokens.push(a);else{var f=new Var(a.value);f.col=a.col,f.line=a.line,this.ptokens.push(f)}},"undefined"!=typeof module&&(module.exports.ParserL2=ParserL2),ParserL3.prototype.process=function(){var a=[];for(var b in this.op_list)for(var c=this.op_list[b],d=0;d<this.expressions.length;d++){var e=a[d]||this.expressions[d],f=ParserL3.process_expression(c,e);a[d]=f}return a},ParserL3.process_expression=function(a,b){for(var c;;){var d=c||b,e=ParserL3._process_expression(a,d),f=e[1];if(c=e[0],0==f)break}return c},ParserL3._process_expression=function(a,b){for(var c=[],d=0,e=0;e<b.length;e++){var f=b[e];if(f instanceof Functor&&"expr"==f.name&&1==f.args.length&&(f=f.args[0]),f instanceof Functor){var g=f.args,h=ParserL3.process_expression(a,g);f.args=h}if(f instanceof OpNode)if(a.symbol==f.symbol){var i=c[e-1],j=b[e+1],k=this._process_one(a,i,f,j);null!=k?(d++,k.is_unary||c.pop(),c.push(k.result),e++):c.push(f)}else c.push(f);else c.push(f)}return[c,d]},ParserL3._process_one=function(a,b,c,d){var e=OpNode.create_from_name(a.name),f=Op.classify_triplet(b,e,d),g=Op.are_compatible_types(f,a.type);if(!g)return null;var h=new Functor(a.name);h.col=c.col,h.line=c.line,h.attrs=a.attrs;var i=Op.is_unary(a.type);return i?h.args=[d]:h.args=[b,d],{is_unary:i,result:h}},"undefined"!=typeof module&&(module.exports.ParserL3=ParserL3),Utils.compare_objects=function(a,b,c){if(a instanceof Array){if(!(b instanceof Array)){if(c)throw new Error("Expecting an array");return!1}if(b.length!=a.length){if(c)throw new Error("Expecting arrays of same arity");return!1}for(var d=0;d<a.length;d++)if(!Utils.compare_objects(a[d],b[d],c))return!1;return!0}if(a===b)return!0;if(("function"==typeof b||"string"==typeof a)&&b.inspect){var e=b.inspect();if(e==a)return!0;if(e=e.replace(/^\s+|\s+$/g,""),e==a)return!0}if(a&&a.inspect){if(b&&!b.inspect){if(c)throw new Error("Expecting 'inspect' method on: "+JSON.stringify(b));return!1}if(a.inspect()!=b.inspect()){if(c)throw new Error("Expecting match using inspect: "+JSON.stringify(a));return!1}}if("object"==typeof a){if("object"!=typeof b){if(c)throw new Error("Expecting "+JSON.stringify(a)+" object, got: "+JSON.stringify(b));return!1}for(var f in a){var g=a[f],h=b[f];if(g!=h){if(!g||!h){if(c)throw new Error("Expected/Input got undefined: e="+JSON.stringify(g)+", i:"+JSON.stringify(h));return!1}if(g.hasOwnProperty(f)!==h.hasOwnProperty(f)){if(c)throw new Error("Expecting property: "+f);return!1}if(!Utils.compare_objects(g,h))return!1}}return!0}if(c)throw new Error("Unsupported check, expected: "+JSON.stringify(a));return!1},Utils.unify=function(a,b,c){if(a==b)return!0;var d,e,f=a instanceof Var,g=b instanceof Var;if(f&&g){var d=a.deref(b),e=b.deref(a);return null==d||null==e?!0:d.is_bound()&&e.is_bound()?Utils.unify(d.get_value(),e.get_value(),c):d.is_bound()?(b.safe_bind(a,c),!0):e.is_bound()?(a.safe_bind(b,c),!0):(d.bind(b,c),!0)}if(f)return d=d||a.deref(),d.is_bound()?Utils.unify(d.get_value(),b,c):(d.bind(b,c),!0);if(g)return e=e||b.deref(),e.is_bound()?Utils.unify(e.get_value(),a,c):(e.bind(a,c),!0);if(a instanceof Functor&&b instanceof Functor){if(a.args.length!=b.args.length)return!1;for(var h in a.args)if(!Utils.unify(a.args[h],b.args[h],c))return!1;return!0}var i,j;return i=a instanceof Token?a.value:a,j=b instanceof Token?b.value:b,i==j},Utils.pad=function(a,b,c){return a+Array(b-a.length).join(c||" ")},Utils.isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},"undefined"!=typeof module&&(module.exports.Utils=Utils),Visitor.prototype.process=function(a){if(!this.exp.args)throw new Error("Expecting a rooted tree, got: "+JSON.stringify(exp));return this.cb=a,this._process_depth(this.exp)},Visitor.prototype._process_depth=function(a){if(!a)throw new Error("Visitor: got an undefined node.");return this.__process_depth(a)},Visitor.prototype.__process_depth=function(a){a.is_root=!0;for(var b=[a],c=0,d=[],e={};;){var f=b.pop();if(!f)break;e={n:f,v:f.v||c++,is_struct:f instanceof Functor},this.cb(e);for(var g=0;g<f.args.length;g++){var h=f.args[g];h.args&&h.args.length>0?(h.v=c++,this.cb({n:h,is_struct:!0,i:g,v:h.v,as_param:!0}),b.unshift(h)):this.cb({n:h,i:g,root_param:f.is_root})}}return d},Visitor2.prototype.process=function(a){if(!(this.exp instanceof Functor))throw new ErrorExpectingFunctor("Expecting a rooted tree, got: "+JSON.stringify(this.exp));this.exp.root=!0,this.cb=a,this._process(this.exp)},Visitor2.prototype._process=function(a,b){if(b=b||1,!a)throw new ErrorExpectingFunctor("Visitor2: got an undefined node.");if(!(a instanceof Functor))throw new ErrorExpectingFunctor("Visitor2: expecting a Functor, got: ",a);for(var c=[],d=0;d<a.args.length;d++){var e=a.args[d];e instanceof Functor?(b=this._process(e,b),c.push(new Value(b++))):c.push(e)}return this.cb({n:a,args:c,vc:b,root:a.root}),b},Visitor3.prototype.process=function(a){this.cb=a,this._process(this.exp)},Visitor3.prototype._process=function(a,b){var c=void 0==b;if(b=b||0,!a)throw new ErrorExpectingFunctor("Visitor3: got an undefined node.");if(!(a instanceof Functor))throw new ErrorExpectingFunctor("Visitor3: expecting a Functor, got: "+JSON.stringify(a));if("conj"!=a.name&&"disj"!=a.name)return c?this.cb({type:"root",vc:b},{n:a},null):{vc:b,n:a,is_junction:!1};var d=a.args[0],e=a.args[1],f=this._process(d,b+1),g=f.vc+1,h=this._process(e,g);return h.vc=g,f.vc=b+1,h.is_junction&&delete h.n,f.is_junction&&delete f.n,delete f.is_junction,delete h.is_junction,this.cb({type:a.name,vc:b,root:c},f,h),{vc:h.vc,is_junction:!0}},"undefined"!=typeof module&&(module.exports.Visitor=Visitor,module.exports.Visitor2=Visitor2,module.exports.Visitor3=Visitor3);